# Hyperspectral CNN Accelerator for Wildfire Fuel Classification

## Overview
This project implements a custom hardware accelerator for real-time hyperspectral
image processing, developed as part of the SMART FIRES initiative. The system is
designed to perform 3D Convolutional Neural Network (CNN) operations on
hyperspectral datacubes to identify fuel sources and conditions directly in the
field.

## System Specifications
- **Target Hardware:** Xilinx Zynq UltraScale+ MPSoC (XCZU15EG)
- **Clock Frequency:** 100 MHz
- **Throughput:** 227 Frames Per Second (FPS)
- **Input Data:** 1100 x 400 x 5 Datacubes (Streaming 1100 x 400 x 1 slices).
  Data is streamed in column-major order: iterating through the Y-dimension
  (1-400) for each step in the X-dimension (1-1100).
- **Kernel Size:** 5 x 400 x 5.
  Kernel data is streamed in the following order: Y-dimension (1-400), then
  X-dimension (1-5), then Z-dimension (1-5).

## Architecture
The design features a custom pipelined architecture optimized for the Zynq
UltraScale+ platform:

1.  **Memory Controller:** Utilizes Xilinx UltraRAM blocks with a circular
    buffering scheme to handle continuous data streaming.
2.  **Data Slicer:** Unpacks 72-bit memory words into parallel data streams (4
    values/clock).
3.  **Convolution Engine:** A hierarchical multiply-accumulate (MAC) structure
    that processes 60 multiplications per clock cycle using DSP48E2 primitives.

## Resource Utilization
The design utilizes the following FPGA resources on the XCZU15EG:
- **UltraRAM:** 100 Blocks (95 for Frame Buffer, 5 for Kernel Weights)
- **Block RAM:** 30 Blocks
- **DSP Slices:** 602
- **LUTs:** 26,061
- **Registers:** 61,394

## Development Workflow
- **Modeling:** MATLAB Simulink 2023b
- **HLS/Synthesis:** Vitis Model Composer 2024.1
- **Verification:** Bit-true matching against reference calculations.

## Project Structure
- `CMOS_Kernel_Memory_Sync.slx`: The Simulink model source file.
- `Kernel_Setup_Script.m`: MATLAB script for configuring and verifying the
  simulation.
- `/vhdl`: Contains the VHDL source files generated by Vitis Model Composer.
  **Note:** These generated files have **not** been tested. Only the MATLAB
  Simulink model has been verified against the reference calculations.

## Usage
To simulate the design, you must first generate the necessary test vectors and
reference data.

### 1. Configure Simulation Parameters
Open `Kernel_Setup_Script.m` and modify the following parameters to customize
the simulation:
- **Data Generation:** Set `input_data_random` and `kernel_data_random` to
  `true` for random data or `false` for sequential patterns.
- **Frame Count:** Adjust `z_depth_input` to add or remove simulated frames.
  **Note:** This is the only dimension parameter safe to modify for standard
  simulations. Be aware that increasing the frame count will linearly increase
  the simulation time.
- **Dimensions Warning:** Do NOT modify `x_length_input`, `y_height_input`, or
  kernel dimensions. These values are tightly coupled to the underlying hardware
  architecture. Changing them without corresponding hardware modifications will
  result in simulation errors.

### 2. Run Setup Script
**IMPORTANT:** You must run `Kernel_Setup_Script.m` *before* opening or running
the Simulink model. This script performs the following:
- **Generates Test Vectors:** Creates input and kernel data.
- **Internal Verification:** Validates the reference data using three independent
  methods to ensure accuracy:
    1.  **Full Calculation:** Standard nested-loop convolution.
    2.  **Sliding Window:** Optimized calculation using pre-computed slice contributions.
    3.  **MATLAB `convn`:** Built-in N-dimensional convolution function.
- **Output Generation:** Creates MATLAB `timeseries` objects for Simulink and
  stores the verified reference result in `convolution_result_convn_flatten`.

### 3. Run Simulation
1.  **Open Simulink:** Launch Simulink from the MATLAB console.
2.  **Load Model:** Open the Simulink model file (`CMOS_Kernel_Memory_Sync.slx`)
    located within this repository.
3.  **Set Simulation Time:** Configure the simulation stop time.
    **IMPORTANT:** If you increased the frame count, you must extend the
    simulation period to allow enough time for all results to be collected.
4.  **Run:** Execute the simulation.

**Data Flow:**
- **Inputs:** The Simulink model reads the `timeseries` objects generated by
  `Kernel_Setup_Script.m` from the MATLAB workspace.
- **Outputs:** An enabled subsystem within the model captures the output data
  only when a valid signal is asserted, exporting the results to the workspace
  variable `out.simout_kernel_values_out`.

The hardware output will be logged to the workspace. Run the following command
in the MATLAB console to verify correctness:

```matlab
mismatch = find(out.simout_kernel_values_out ~= convolution_result_convn_flatten);
```

If `mismatch` is empty, the hardware simulation matches the reference
calculation.